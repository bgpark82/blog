---
title: 레거시 알림 서비스 개편
catalog: true
date: 2022-11-02 21:33:41
subtitle:
header-img:
tags:
---

회사 서비스가 중국으로 진출하면서 wechat 서비스를 개발하면서 발생한 이슈에 대해 공유해보려 합니다.

기존에 알림, AI 모델 변환 요청 등의 요청들은 응답을 기다리지 않고 처리할 수 있는 요청(fire and forget)으로 이벤트 방식으로 처리해왔습니다. Publish/Subscribe 방식의 이벤트를 사용하여 이벤트를 보내는 서비스와 관계없이 알림 요청, AI 변환 요청 서비스는 지정된 이벤트만 수신하는 방식으로 서비스간 디커플링하고 있었습니다.

문제는 **이벤트를 동기적**으로 사용하고 있었습니다. 



# 전통적인 동기 방식의 코드

기존의 동기 방식의 코드를 살펴보자

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class PaymentService {

    private final RewardService rewardService;
    private final InspectionService inspectionService;
    private final NotificationService notificationService;

    @Transactional
    public void buy(int price) {
        rewardService.reward(price); //
        inspectionService.inspect(price);
        notificationService.send(price);
    }
}
```

문제는 2가지이다

1. 하나의 코드에 많은 시간이 지나면 다른 코드에 영향을 미친다.
2. 서비스간 의존성이 발생한다.
3. fire and forget 방식의 메소드가 실패해도 모두 롤백해버린다

# 동기방식의 이벤트 코드

기존의 동기 방식의 이벤트 코드를 살펴보자

문제는 2가지이다.

1. 별도의 트랜잭션으로 제어를 할 수 없다
2. 하나의 이벤트 핸들러가 실패하면 다른 이벤트 핸들러에 영향을 미친다

# 스프링이 제공하는 ApplicationEventPublisher

위의 문제를 해결할 수 있다

1. 별도 트랜잭션 제어
2. 하나의 이벤트 핸들러가 실패하면 다른 핸들러에 영향
